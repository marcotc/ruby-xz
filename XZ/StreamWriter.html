<!DOCTYPE html>

<html>
<head>
<meta charset="UTF-8">

<title>class XZ::StreamWriter - ruby-xz RDocs</title>

<script type="text/javascript">
  var rdoc_rel_prefix = "../";
</script>

<script src="../js/jquery.js"></script>
<script src="../js/darkfish.js"></script>

<link href="../css/fonts.css" rel="stylesheet">
<link href="../css/rdoc.css" rel="stylesheet">



<body id="top" role="document" class="class">
<nav role="navigation">
  <div id="project-navigation">
    <div id="home-section" role="region" title="Quick navigation" class="nav-section">
  <h2>
    <a href="../index.html" rel="home">Home</a>
  </h2>

  <div id="table-of-contents-navigation">
    <a href="../table_of_contents.html#pages">Pages</a>
    <a href="../table_of_contents.html#classes">Classes</a>
    <a href="../table_of_contents.html#methods">Methods</a>
  </div>
</div>

    <div id="search-section" role="search" class="project-section initially-hidden">
  <form action="#" method="get" accept-charset="utf-8">
    <div id="search-field-wrapper">
      <input id="search-field" role="combobox" aria-label="Search"
             aria-autocomplete="list" aria-controls="search-results"
             type="text" name="search" placeholder="Search" spellcheck="false"
             title="Type to search, Up and Down to navigate, Enter to load">
    </div>

    <ul id="search-results" aria-label="Search Results"
        aria-busy="false" aria-expanded="false"
        aria-atomic="false" class="initially-hidden"></ul>
  </form>
</div>

  </div>

  

  <div id="class-metadata">
    
    <div id="parent-class-section" class="nav-section">
  <h3>Parent</h3>

  
  <p class="link"><a href="Stream.html">XZ::Stream</a>
  
</div>

    
    
    <!-- Method Quickref -->
<div id="method-list-section" class="nav-section">
  <h3>Methods</h3>

  <ul class="link-list" role="directory">
    
    <li class="calls-super" ><a href="#method-c-new">::new</a>
    
    <li ><a href="#method-c-open">::open</a>
    
    <li class="calls-super" ><a href="#method-i-close">#close</a>
    
    <li ><a href="#method-i-finish">#finish</a>
    
    <li ><a href="#method-i-pos">#pos</a>
    
    <li ><a href="#method-i-tell">#tell</a>
    
  </ul>
</div>

  </div>
</nav>

<main role="main" aria-labelledby="class-XZ::StreamWriter">
  <h1 id="class-XZ::StreamWriter" class="class">
    class XZ::StreamWriter
  </h1>

  <section class="description">
    
<p>An IO-like writer class for XZ-compressed data, allowing you to write
uncompressed data to a stream which ends up as compressed data in a wrapped
stream such as a file.</p>

<p>A <a href="StreamWriter.html">StreamWriter</a> object actually wraps
another IO object it writes the XZ-compressed data to. Here’s an ASCII art
image to demonstrate way data flows when using <a
href="StreamWriter.html">StreamWriter</a> to write to a compressed file:</p>

<pre>        +----------------+  +------------+
YOUR  =&gt;|StreamWriter&#39;s  |=&gt;|Wrapped IO&#39;s|=&gt; ACTUAL
DATA  =&gt;|internal buffers|=&gt;|buffers     |=&gt;  FILE
        +----------------+  +------------+</pre>

<p>This graphic also illustrates why it is unlikely to see written data
directly appear in the file on your harddisk; the data is cached at least
twice before it actually gets written out. Regarding file closing that
means that before you can be sure any pending data has been written to the
file you have to close both the <a
href="StreamWriter.html">StreamWriter</a> instance and then the wrapped IO
object (in <strong>exactly</strong> that order, otherwise data loss and
unexpected exceptions may occur!).</p>

<p>As it might be tedious to always remember the correct closing order, it’s
possible to pass a filename to the <a
href="StreamWriter.html#method-c-open">::open</a> method. In this case, <a
href="StreamWriter.html">StreamWriter</a> will open the file internally and
also takes care closing it when you call the <a
href="StreamWriter.html#method-i-close">close</a> method.</p>

<p><strong>WARNING</strong>: The closing behaviour described above is subject
to change in the next major version. In the future, wrapped IO objects are
automatically closed always, regardless of whether you passed a filename or
an IO instance. This is to sync the API with Ruby’s own Zlib::GzipWriter.
To retain the old behaviour, call the <a
href="StreamWriter.html#method-i-finish">finish</a> method (which is also
in sync with the Zlib API).</p>

<p>See the <code>io-like</code> gem’s documentation for the IO-writing methods
available for this class (although you’re probably familiar with them
through Ruby’s own IO class ;-)).</p>

<h2 id="class-XZ::StreamWriter-label-Example">Example<span><a href="#class-XZ::StreamWriter-label-Example">&para;</a> <a href="#top">&uarr;</a></span></h2>

<p>Together with the <code>archive-tar-minitar</code> gem, this library can be
used to create XZ-compressed TAR archives (these commonly use a file
extension of <code>.tar.xz</code> or rarely <code>.txz</code>).</p>

<pre class="ruby"><span class="ruby-constant">XZ</span><span class="ruby-operator">::</span><span class="ruby-constant">StreamWriter</span>.<span class="ruby-identifier">open</span>(<span class="ruby-string">&quot;foo.tar.xz&quot;</span>) <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">txz</span><span class="ruby-operator">|</span>
  <span class="ruby-comment"># This automatically closes txz</span>
  <span class="ruby-constant">Archive</span><span class="ruby-operator">::</span><span class="ruby-constant">Tar</span><span class="ruby-operator">::</span><span class="ruby-constant">Minitar</span>.<span class="ruby-identifier">pack</span>(<span class="ruby-string">&quot;foo&quot;</span>, <span class="ruby-identifier">txz</span>)
<span class="ruby-keyword">end</span>
</pre>

  </section>

  
  
  
  <section id="5Buntitled-5D" class="documentation-section">
    

    

    

    

    
     <section id="public-class-5Buntitled-5D-method-details" class="method-section">
       <header>
         <h3>Public Class Methods</h3>
       </header>

    
      <div id="method-c-new" class="method-detail ">
        
        
        <div class="method-heading">
          <span class="method-callseq">
            new(delegate, compression_level = 6, opts = {}) → writer
          </span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        
        <div class="method-heading">
          <span class="method-callseq">
            new(delegate, compression_level = 6, opts = {}){|writer| …} → obj
          </span>
          
        </div>
        
        

        <div class="method-description">
          
          <p>Creates a new <a href="StreamWriter.html">StreamWriter</a> instance. The
block form automatically calls the <a
href="StreamWriter.html#method-i-close">close</a> method when the block has
finished executing.</p>

<h3 id="method-c-new-label-Parameters">Parameters<span><a href="#method-c-new-label-Parameters">&para;</a> <a href="#top">&uarr;</a></span></h3>
<dl class="rdoc-list label-list"><dt>delegate
<dd>
<p>An IO object to write the data to</p>
</dd><dt>compression_level (6)
<dd>
<p>Compression strength. Higher values indicate a smaller result, but longer
compression time. Maximum is 9.</p>
</dd><dt>opts
<dd>
<p>Options hash. Possible values are (defaults indicated in parantheses):</p>
<dl class="rdoc-list label-list"><dt>:check (:crc64)
<dd>
<p>The checksum algorithm to use for verifying the data inside the archive.
Possible values are:</p>
<ul><li>
<p>:none</p>
</li><li>
<p>:crc32</p>
</li><li>
<p>:crc64</p>
</li><li>
<p>:sha256</p>
</li></ul>
</dd><dt>:extreme (false)
<dd>
<p>Tries to get the last bit out of the compression. This may succeed, but you
can end up with <strong>very</strong> long computation times.</p>
</dd></dl>
</dd><dt>writer
<dd>
<p>Block argument. self of the new instance.</p>
</dd></dl>

<h3 id="method-c-new-label-Return+value">Return value<span><a href="#method-c-new-label-Return+value">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>The block form returns the block’s last expression, the nonblock form
returns the newly created instance.</p>

<h3 id="method-c-new-label-Deprecations">Deprecations<span><a href="#method-c-new-label-Deprecations">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>The old API for this method as it was documented in version 0.2.1 still
works, but is deprecated. Please change to the new API as soon as possible.</p>

<p><strong>WARNING</strong>: The closing behaviour of the block form is
subject to upcoming change. In the next major release the wrapped IO
<strong>will</strong> be automatically closed, unless you call <a
href="StreamWriter.html#method-i-finish">finish</a> to prevent that.</p>

<h3 id="method-c-new-label-Example">Example<span><a href="#method-c-new-label-Example">&para;</a> <a href="#top">&uarr;</a></span></h3>

<pre class="ruby"><span class="ruby-comment"># Wrap it around a file</span>
<span class="ruby-identifier">f</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">open</span>(<span class="ruby-string">&quot;data.xz&quot;</span>)
<span class="ruby-identifier">w</span> = <span class="ruby-constant">XZ</span><span class="ruby-operator">::</span><span class="ruby-constant">StreamWriter</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">f</span>)

<span class="ruby-comment"># Use SHA256 as the checksum and use a higher compression level</span>
<span class="ruby-comment"># than the default (6)</span>
<span class="ruby-identifier">f</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">open</span>(<span class="ruby-string">&quot;data.xz&quot;</span>)
<span class="ruby-identifier">w</span> = <span class="ruby-constant">XZ</span><span class="ruby-operator">::</span><span class="ruby-constant">StreamWriter</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">f</span>, <span class="ruby-value">8</span>, :<span class="ruby-identifier">check</span> =<span class="ruby-operator">&gt;</span> :<span class="ruby-identifier">sha256</span>)

<span class="ruby-comment"># Instruct liblzma to use ultra-really-high compression</span>
<span class="ruby-comment"># (may take eternity)</span>
<span class="ruby-identifier">f</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">open</span>(<span class="ruby-string">&quot;data.xz&quot;</span>)
<span class="ruby-identifier">w</span> = <span class="ruby-constant">XZ</span><span class="ruby-operator">::</span><span class="ruby-constant">StreamWriter</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">f</span>, <span class="ruby-value">9</span>, :<span class="ruby-identifier">extreme</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword">true</span>)
</pre>
          
          
            <div class="method-calls-super">
              Calls superclass method
              <a href="Stream.html#method-c-new">XZ::Stream.new</a>
            </div>
          

          
          <div class="method-source-code" id="new-source">
            <pre><span class="ruby-comment"># File lib/xz/stream_writer.rb, line 141</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">initialize</span>(<span class="ruby-identifier">delegate</span>, <span class="ruby-identifier">compression_level</span> = <span class="ruby-value">6</span>, <span class="ruby-operator">*</span><span class="ruby-identifier">args</span>, <span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>)
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">delegate</span>.<span class="ruby-identifier">respond_to?</span>(<span class="ruby-value">:to_io</span>)
    <span class="ruby-comment"># Correct use with IO</span>
    <span class="ruby-keyword">super</span>(<span class="ruby-identifier">delegate</span>.<span class="ruby-identifier">to_io</span>)
    <span class="ruby-ivar">@autoclose</span> = <span class="ruby-keyword">false</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-comment"># Deprecated use of filename</span>
    <span class="ruby-constant">XZ</span>.<span class="ruby-identifier">deprecate</span> <span class="ruby-string">&quot;Calling XZ::StreamWriter.new with a filename is deprecated, use XZ::StreamWriter.open instead&quot;</span>

    <span class="ruby-ivar">@autoclose</span> = <span class="ruby-keyword">true</span>
    <span class="ruby-keyword">super</span>(<span class="ruby-constant">File</span>.<span class="ruby-identifier">open</span>(<span class="ruby-identifier">delegate</span>, <span class="ruby-string">&quot;wb&quot;</span>))
  <span class="ruby-keyword">end</span>

  <span class="ruby-comment"># Flag for #finish method</span>
  <span class="ruby-ivar">@finish</span> = <span class="ruby-keyword">false</span>

  <span class="ruby-identifier">opts</span> = {}
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">args</span>[<span class="ruby-value">0</span>].<span class="ruby-identifier">kind_of?</span>(<span class="ruby-constant">Hash</span>) <span class="ruby-comment"># New API</span>
    <span class="ruby-identifier">opts</span> = <span class="ruby-identifier">args</span>[<span class="ruby-value">0</span>]
    <span class="ruby-identifier">opts</span>[<span class="ruby-value">:check</span>] <span class="ruby-operator">||=</span> <span class="ruby-value">:crc64</span>
    <span class="ruby-identifier">opts</span>[<span class="ruby-value">:extreme</span>] <span class="ruby-operator">||=</span> <span class="ruby-keyword">false</span>
  <span class="ruby-keyword">else</span> <span class="ruby-comment"># Old API</span>
    <span class="ruby-comment"># no arguments may also happen in new API</span>
    <span class="ruby-keyword">unless</span> <span class="ruby-identifier">args</span>.<span class="ruby-identifier">empty?</span>
      <span class="ruby-constant">XZ</span>.<span class="ruby-identifier">deprecate</span> <span class="ruby-string">&quot;Calling XZ::StreamWriter withm ore than 2 explicit arguments is deprecated, use options hash instead.&quot;</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">opts</span>[<span class="ruby-value">:check</span>] = <span class="ruby-identifier">args</span>[<span class="ruby-value">0</span>] <span class="ruby-operator">||</span> <span class="ruby-value">:crc64</span>
    <span class="ruby-identifier">opts</span>[<span class="ruby-value">:extreme</span>] = <span class="ruby-identifier">args</span>[<span class="ruby-value">1</span>] <span class="ruby-operator">||</span> <span class="ruby-keyword">false</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-comment"># TODO: Check argument validity...</span>

  <span class="ruby-comment"># Initialize the internal LZMA stream for encoding</span>
  <span class="ruby-identifier">res</span> = <span class="ruby-constant">XZ</span><span class="ruby-operator">::</span><span class="ruby-constant">LibLZMA</span>.<span class="ruby-identifier">lzma_easy_encoder</span>(<span class="ruby-ivar">@lzma_stream</span>.<span class="ruby-identifier">pointer</span>,
                                <span class="ruby-identifier">compression_level</span> <span class="ruby-operator">|</span> (<span class="ruby-identifier">opts</span>[<span class="ruby-value">:extreme</span>] <span class="ruby-operator">?</span> <span class="ruby-constant">XZ</span><span class="ruby-operator">::</span><span class="ruby-constant">LibLZMA</span><span class="ruby-operator">::</span><span class="ruby-constant">LZMA_PRESET_EXTREME</span> <span class="ruby-operator">:</span> <span class="ruby-value">0</span>),
                                <span class="ruby-constant">XZ</span><span class="ruby-operator">::</span><span class="ruby-constant">LibLZMA</span><span class="ruby-operator">::</span><span class="ruby-constant">LZMA_CHECK</span>[<span class="ruby-value">:&quot;lzma_check_#{opts[:check]}&quot;</span>])
  <span class="ruby-constant">XZ</span><span class="ruby-operator">::</span><span class="ruby-constant">LZMAError</span>.<span class="ruby-identifier">raise_if_necessary</span>(<span class="ruby-identifier">res</span>)

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">block_given?</span>
    <span class="ruby-keyword">begin</span>
      <span class="ruby-keyword">yield</span>(<span class="ruby-keyword">self</span>)
    <span class="ruby-keyword">ensure</span>
      <span class="ruby-identifier">close</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">closed?</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-c-open" class="method-detail ">
        
        
        <div class="method-heading">
          <span class="method-callseq">
            open(filename, compression_level = 6, opts = {}) → writer
          </span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        
        <div class="method-heading">
          <span class="method-callseq">
            open(filename, compression_level = 6, opts = {}){|writer| …} → obj
          </span>
          
        </div>
        
        

        <div class="method-description">
          
          <p>Opens a file from disk and wraps an <a
href="StreamWriter.html">XZ::StreamWriter</a> instance around the resulting
file IO object. This is a convenience method mostly equivalent to</p>

<pre class="ruby"><span class="ruby-identifier">file</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">open</span>(<span class="ruby-identifier">filename</span>, <span class="ruby-string">&quot;wb&quot;</span>)
<span class="ruby-identifier">writer</span> = <span class="ruby-constant">XZ</span><span class="ruby-operator">::</span><span class="ruby-constant">StreamWriter</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">file</span>, <span class="ruby-identifier">compression_level</span>, <span class="ruby-identifier">opts</span>)
</pre>

<p>, except that you don’t have to explicitely close the File instance, this
is done automatically for you when you call <a
href="StreamWriter.html#method-i-close">close</a>. Beware the Deprecations
section in this regard.</p>

<h3 id="method-c-open-label-Parameters">Parameters<span><a href="#method-c-open-label-Parameters">&para;</a> <a href="#top">&uarr;</a></span></h3>
<dl class="rdoc-list label-list"><dt>filename
<dd>
<p>Path to a file on the disk to open. This file should exist and be writable,
otherwise you may get Errno exceptions.</p>
</dd><dt>opts
<dd>
<p>Options hash. See <a href="StreamWriter.html#method-c-new">::new</a> for a
description of the possible options.</p>
</dd><dt>writer
<dd>
<p>Block argument. self of the new instance.</p>
</dd></dl>

<h3 id="method-c-open-label-Return+value">Return value<span><a href="#method-c-open-label-Return+value">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>The block form returns the blocks last expression, the nonblock form
returns the newly created <a href="StreamWriter.html">XZ::StreamWriter</a>
instance.</p>

<h3 id="method-c-open-label-Deprecations">Deprecations<span><a href="#method-c-open-label-Deprecations">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>In the API up to and including version 0.2.1 this method was an alias for
<a href="StreamWriter.html#method-c-new">::new</a>. This continues to work
for now, but using it as an alias for <a
href="StreamWriter.html#method-c-new">::new</a> is deprecated. The next
major version will only accept a string as a parameter for this method.</p>

<p><strong>WARNING</strong>: Future versions of ruby-xz will always close the
wrapped IO, regardless of whether you pass in your own IO or use this
convenience method, unless you call <a
href="StreamWriter.html#method-i-finish">finish</a> to prevent that.</p>

<h3 id="method-c-open-label-Example">Example<span><a href="#method-c-open-label-Example">&para;</a> <a href="#top">&uarr;</a></span></h3>

<pre class="ruby"><span class="ruby-identifier">w</span> = <span class="ruby-constant">XZ</span><span class="ruby-operator">::</span><span class="ruby-constant">StreamWriter</span>.<span class="ruby-identifier">new</span>(<span class="ruby-string">&quot;compressed_data.xz&quot;</span>)
</pre>
          
          

          
          <div class="method-source-code" id="open-source">
            <pre><span class="ruby-comment"># File lib/xz/stream_writer.rb, line 236</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">open</span>(<span class="ruby-identifier">filename</span>, <span class="ruby-identifier">compression_level</span> = <span class="ruby-value">6</span>, <span class="ruby-operator">*</span><span class="ruby-identifier">args</span>, <span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>)
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">filename</span>.<span class="ruby-identifier">respond_to?</span>(<span class="ruby-value">:to_io</span>)
    <span class="ruby-comment"># Deprecated use of IO</span>
    <span class="ruby-constant">XZ</span>.<span class="ruby-identifier">deprecate</span> <span class="ruby-string">&quot;Calling XZ::StreamWriter.open with an IO is deprecated, use XZ::StreamReader.new instead.&quot;</span>
    <span class="ruby-identifier">new</span>(<span class="ruby-identifier">filename</span>.<span class="ruby-identifier">to_io</span>, <span class="ruby-identifier">compression_level</span>, <span class="ruby-operator">*</span><span class="ruby-identifier">args</span>, <span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>)
  <span class="ruby-keyword">else</span>
    <span class="ruby-comment"># Correct use with filename</span>
    <span class="ruby-identifier">file</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">open</span>(<span class="ruby-identifier">filename</span>, <span class="ruby-string">&quot;wb&quot;</span>)

    <span class="ruby-identifier">obj</span> = <span class="ruby-identifier">new</span>(<span class="ruby-identifier">file</span>, <span class="ruby-identifier">compression_level</span>, <span class="ruby-operator">*</span><span class="ruby-identifier">args</span>)
    <span class="ruby-identifier">obj</span>.<span class="ruby-identifier">instance_variable_set</span>(<span class="ruby-value">:@autoclose</span>, <span class="ruby-keyword">true</span>) <span class="ruby-comment"># Only needed during deprecation phase, see #close</span>

    <span class="ruby-keyword">if</span> <span class="ruby-identifier">block_given?</span>
      <span class="ruby-keyword">begin</span>
        <span class="ruby-identifier">block</span>.<span class="ruby-identifier">call</span>(<span class="ruby-identifier">obj</span>)
      <span class="ruby-keyword">ensure</span>
        <span class="ruby-identifier">obj</span>.<span class="ruby-identifier">close</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">obj</span>.<span class="ruby-identifier">closed?</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">obj</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
    </section>
  
     <section id="public-instance-5Buntitled-5D-method-details" class="method-section">
       <header>
         <h3>Public Instance Methods</h3>
       </header>

    
      <div id="method-i-close" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">close</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Closes this <a href="StreamWriter.html">StreamWriter</a> instance and
flushes all internal buffers. Don’t use it afterwards anymore.</p>

<h3 id="method-i-close-label-Return+value">Return value<span><a href="#method-i-close-label-Return+value">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>The total number of bytes written, i.e. the size of the compressed data.</p>

<h3 id="method-i-close-label-Example">Example<span><a href="#method-i-close-label-Example">&para;</a> <a href="#top">&uarr;</a></span></h3>

<pre class="ruby"><span class="ruby-identifier">w</span>.<span class="ruby-identifier">close</span> <span class="ruby-comment">#=&gt; 424</span>
</pre>

<h3 id="method-i-close-label-Remarks">Remarks<span><a href="#method-i-close-label-Remarks">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>If you passed an IO object to <a
href="StreamWriter.html#method-c-new">::new</a>, this method doesn’t close
it, you have to do that yourself.</p>

<p><strong>WARNING</strong>: The next major release will change this
behaviour. In the future, the wrapped IO object will always be closed. Use
the <a href="StreamWriter.html#method-i-finish">finish</a> method for
keeping it open.</p>
          
          
            <div class="method-calls-super">
              Calls superclass method
              
            </div>
          

          
          <div class="method-source-code" id="close-source">
            <pre><span class="ruby-comment"># File lib/xz/stream_writer.rb, line 280</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">close</span>
  <span class="ruby-keyword">super</span>

  <span class="ruby-comment">#1. Close the current block (&quot;file&quot;) (an XZ stream may actually include</span>
  <span class="ruby-comment">#   multiple compressed files, which however is not supported by</span>
  <span class="ruby-comment">#   this library). For this we have to tell liblzma that</span>
  <span class="ruby-comment">#   the next bytes we pass to it are the last bytes (by means of</span>
  <span class="ruby-comment">#   the FINISH action). Just that we don’t pass any new input ;-)</span>

  <span class="ruby-identifier">output_buffer_p</span>         = <span class="ruby-constant">FFI</span><span class="ruby-operator">::</span><span class="ruby-constant">MemoryPointer</span>.<span class="ruby-identifier">new</span>(<span class="ruby-constant">XZ</span><span class="ruby-operator">::</span><span class="ruby-constant">CHUNK_SIZE</span>)

  <span class="ruby-comment"># Get any pending data (LZMA_FINISH causes libzlma to flush its</span>
  <span class="ruby-comment"># internal buffers) and write it out to our wrapped IO.</span>
  <span class="ruby-identifier">loop</span> <span class="ruby-keyword">do</span>
    <span class="ruby-ivar">@lzma_stream</span>[<span class="ruby-value">:next_out</span>]  = <span class="ruby-identifier">output_buffer_p</span>
    <span class="ruby-ivar">@lzma_stream</span>[<span class="ruby-value">:avail_out</span>] = <span class="ruby-identifier">output_buffer_p</span>.<span class="ruby-identifier">size</span>

    <span class="ruby-identifier">res</span> = <span class="ruby-constant">XZ</span><span class="ruby-operator">::</span><span class="ruby-constant">LibLZMA</span>.<span class="ruby-identifier">lzma_code</span>(<span class="ruby-ivar">@lzma_stream</span>.<span class="ruby-identifier">pointer</span>, <span class="ruby-constant">XZ</span><span class="ruby-operator">::</span><span class="ruby-constant">LibLZMA</span><span class="ruby-operator">::</span><span class="ruby-constant">LZMA_ACTION</span>[<span class="ruby-value">:lzma_finish</span>])
    <span class="ruby-constant">XZ</span><span class="ruby-operator">::</span><span class="ruby-constant">LZMAError</span>.<span class="ruby-identifier">raise_if_necessary</span>(<span class="ruby-identifier">res</span>)

    <span class="ruby-ivar">@delegate_io</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">output_buffer_p</span>.<span class="ruby-identifier">read_string</span>(<span class="ruby-identifier">output_buffer_p</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">-</span> <span class="ruby-ivar">@lzma_stream</span>[<span class="ruby-value">:avail_out</span>]))

    <span class="ruby-keyword">break</span> <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@lzma_stream</span>[<span class="ruby-value">:avail_out</span>] <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-comment"># 2. Close the whole XZ stream.</span>
  <span class="ruby-identifier">res</span> = <span class="ruby-constant">XZ</span><span class="ruby-operator">::</span><span class="ruby-constant">LibLZMA</span>.<span class="ruby-identifier">lzma_end</span>(<span class="ruby-ivar">@lzma_stream</span>.<span class="ruby-identifier">pointer</span>)
  <span class="ruby-constant">XZ</span><span class="ruby-operator">::</span><span class="ruby-constant">LZMAError</span>.<span class="ruby-identifier">raise_if_necessary</span>(<span class="ruby-identifier">res</span>)

  <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@finish</span>
    <span class="ruby-comment"># New API: Close the wrapped IO</span>
    <span class="ruby-comment">#@delegate_io.close</span>

    <span class="ruby-comment"># Old API:</span>
    <span class="ruby-comment"># 2b. If we wrapped a file automatically, close it.</span>
    <span class="ruby-keyword">if</span> <span class="ruby-ivar">@autoclose</span>
      <span class="ruby-ivar">@delegate_io</span>.<span class="ruby-identifier">close</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-constant">XZ</span>.<span class="ruby-identifier">deprecate</span> <span class="ruby-node">&quot;XZ::StreamWriter#close will automatically close the wrapped IO in the future. Use #finish to prevent that.&quot;</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-comment"># 3. Return the number of bytes written in total.</span>
  <span class="ruby-ivar">@lzma_stream</span>[<span class="ruby-value">:total_out</span>]
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-finish" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">finish</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>If called in the block form of <a
href="StreamWriter.html#method-c-new">::new</a> or <a
href="StreamWriter.html#method-c-open">::open</a>, prevents the wrapped IO
from being closed, only the LZMA stream is closed then. If called outside
the block form of <a href="StreamWriter.html#method-c-new">::new</a> and
open, behaves like <a href="StreamWriter.html#method-i-close">close</a>,
but only closes the underlying LZMA stream. The wrapped IO object is kept
open.</p>

<h3 id="method-i-finish-label-Return+value">Return value<span><a href="#method-i-finish-label-Return+value">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>Returns the wrapped IO object. This allows you to wire the File instance
out of a StreamReader instance that was created with <a
href="StreamWriter.html#method-c-open">::open</a>.</p>

<h3 id="method-i-finish-label-Example">Example<span><a href="#method-i-finish-label-Example">&para;</a> <a href="#top">&uarr;</a></span></h3>

<pre class="ruby"><span class="ruby-comment"># Nonblock form</span>
<span class="ruby-identifier">f</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">open</span>(<span class="ruby-string">&quot;foo.xz&quot;</span>, <span class="ruby-string">&quot;wb&quot;</span>)
<span class="ruby-identifier">w</span> = <span class="ruby-constant">XZ</span><span class="ruby-operator">::</span><span class="ruby-constant">StreamReader</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">f</span>)
<span class="ruby-comment"># ...</span>
<span class="ruby-identifier">w</span>.<span class="ruby-identifier">finish</span>
<span class="ruby-comment"># f is still open here!</span>

<span class="ruby-comment"># Block form</span>
<span class="ruby-identifier">f</span> = <span class="ruby-constant">XZ</span><span class="ruby-operator">::</span><span class="ruby-constant">StreamReader</span>.<span class="ruby-identifier">open</span>(<span class="ruby-string">&quot;foo.xz&quot;</span>) <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">w</span><span class="ruby-operator">|</span>
  <span class="ruby-comment"># ...</span>
  <span class="ruby-identifier">w</span>.<span class="ruby-identifier">finish</span>
<span class="ruby-keyword">end</span>
<span class="ruby-comment"># f now is an *open* File instance of mode &quot;wb&quot;.</span>
</pre>
          
          

          
          <div class="method-source-code" id="finish-source">
            <pre><span class="ruby-comment"># File lib/xz/stream_writer.rb, line 353</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">finish</span>
  <span class="ruby-comment"># Do not close wrapped IO object in #close</span>
  <span class="ruby-ivar">@finish</span> = <span class="ruby-keyword">true</span>
  <span class="ruby-identifier">close</span>

  <span class="ruby-ivar">@delegate_io</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-pos" class="method-detail ">
        
        
        <div class="method-heading">
          <span class="method-callseq">
            pos()  → an_integer
          </span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        
        <div class="method-heading">
          <span class="method-callseq">
            tell() → an_integer
          </span>
          
        </div>
        
        

        <div class="method-description">
          
          <p>Total number of input bytes read so far from what you supplied to any
writer method.</p>
          
          

          
          <div class="method-source-code" id="pos-source">
            <pre><span class="ruby-comment"># File lib/xz/stream_writer.rb, line 367</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">pos</span>
  <span class="ruby-ivar">@lzma_stream</span>[<span class="ruby-value">:total_in</span>]
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        
        <div class="aliases">
          Also aliased as: <a href="StreamWriter.html#method-i-tell">tell</a>
        </div>
        

        
      </div>

    
      <div id="method-i-tell" class="method-detail method-alias">
        
        <div class="method-heading">
          <span class="method-name">tell</span><span
            class="method-args">()</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
        </div>

        

        
        <div class="aliases">
          Alias for: <a href="StreamWriter.html#method-i-pos">pos</a>
        </div>
        
      </div>

    
    </section>
  
  </section>
</main>


<footer id="validator-badges" role="contentinfo">
  <p><a href="http://validator.w3.org/check/referer">Validate</a>
  <p>Generated by <a href="http://docs.seattlerb.org/rdoc/">RDoc</a> 4.2.0.
  <p>Based on <a href="http://deveiate.org/projects/Darkfish-RDoc/">Darkfish</a> by <a href="http://deveiate.org">Michael Granger</a>.
</footer>

