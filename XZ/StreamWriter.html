<!DOCTYPE html>

<html>
<head>
<meta content="text/html; charset=UTF-8" http-equiv="Content-Type">

<title>class XZ::StreamWriter - ruby-xz RDocs</title>

<link type="text/css" media="screen" href="../rdoc.css" rel="stylesheet">

<script type="text/javascript">
  var rdoc_rel_prefix = "../";
</script>

<script type="text/javascript" charset="utf-8" src="../js/jquery.js"></script>
<script type="text/javascript" charset="utf-8" src="../js/navigation.js"></script>
<script type="text/javascript" charset="utf-8" src="../js/search_index.js"></script>
<script type="text/javascript" charset="utf-8" src="../js/search.js"></script>
<script type="text/javascript" charset="utf-8" src="../js/searcher.js"></script>
<script type="text/javascript" charset="utf-8" src="../js/darkfish.js"></script>


<body id="top" class="class">
<nav id="metadata">
  <nav id="home-section" class="section">
  <h3 class="section-header">
    <a href="../index.html">Home</a>
    <a href="../table_of_contents.html#classes">Classes</a>
    <a href="../table_of_contents.html#methods">Methods</a>
  </h3>
</nav>


  <nav id="search-section" class="section project-section" class="initially-hidden">
  <form action="#" method="get" accept-charset="utf-8">
    <h3 class="section-header">
      <input type="text" name="search" placeholder="Search" id="search-field"
             title="Type to search, Up and Down to navigate, Enter to load">
    </h3>
  </form>

  <ul id="search-results" class="initially-hidden"></ul>
</nav>


  

  <div id="file-metadata">
    <nav id="file-list-section" class="section">
  <h3 class="section-header">Defined In</h3>
  <ul>
    <li>lib/xz/stream_writer.rb
  </ul>
</nav>

    
  </div>

  <div id="class-metadata">
    
    <nav id="parent-class-section" class="section">
  <h3 class="section-header">Parent</h3>
  
  <p class="link"><a href="Stream.html">XZ::Stream</a>
  
</nav>

    
    
    <!-- Method Quickref -->
<nav id="method-list-section" class="section">
  <h3 class="section-header">Methods</h3>

  <ul class="link-list">
    
    <li class="calls-super" ><a href="#method-c-new">::new</a>
    
    <li class="calls-super" ><a href="#method-i-close">#close</a>
    
    <li ><a href="#method-i-pos">#pos</a>
    
    <li ><a href="#method-i-tell">#tell</a>
    
  </ul>
</nav>

  </div>

  <div id="project-metadata">
    <nav id="fileindex-section" class="section project-section">
  <h3 class="section-header">Pages</h3>

  <ul>
  
    <li class="file"><a href="../COPYING.html">COPYING</a>
  
    <li class="file"><a href="../HISTORY_rdoc.html">HISTORY</a>
  
    <li class="file"><a href="../README_rdoc.html">README</a>
  
  </ul>
</nav>

    <nav id="classindex-section" class="section project-section">
  <h3 class="section-header">Class and Module Index</h3>

  <ul class="link-list">
  
    <li><a href="../XZ.html">XZ</a>
  
    <li><a href="../XZ/LZMAError.html">XZ::LZMAError</a>
  
    <li><a href="../XZ/LZMAStream.html">XZ::LZMAStream</a>
  
    <li><a href="../XZ/LibLZMA.html">XZ::LibLZMA</a>
  
    <li><a href="../XZ/Stream.html">XZ::Stream</a>
  
    <li><a href="../XZ/StreamReader.html">XZ::StreamReader</a>
  
    <li><a href="../XZ/StreamWriter.html">XZ::StreamWriter</a>
  
  </ul>
</nav>

  </div>
</nav>

<div id="documentation">
  <h1 class="class">class XZ::StreamWriter</h1>

  <div id="description" class="description">
    
<p>An IO-like writer class for XZ-compressed data, allowing you to write
uncompressed data to a stream which ends up as compressed data in a wrapped
stream such as a file.</p>

<p>A <a href="StreamWriter.html">StreamWriter</a> object actually wraps
another IO object it writes the XZ-compressed data to. Here’s an ASCII art
image to demonstrate way data flows when using <a
href="StreamWriter.html">StreamWriter</a> to write to a compressed file:</p>

<pre class="ruby">        <span class="ruby-operator">+</span><span class="ruby-operator">-</span><span class="ruby-operator">-</span><span class="ruby-operator">-</span><span class="ruby-operator">-</span><span class="ruby-operator">-</span><span class="ruby-operator">-</span><span class="ruby-operator">-</span><span class="ruby-operator">-</span><span class="ruby-operator">-</span><span class="ruby-operator">-</span><span class="ruby-operator">-</span><span class="ruby-operator">-</span><span class="ruby-operator">-</span><span class="ruby-operator">-</span><span class="ruby-operator">-</span><span class="ruby-operator">-</span><span class="ruby-operator">+</span>  <span class="ruby-operator">+</span><span class="ruby-operator">-</span><span class="ruby-operator">-</span><span class="ruby-operator">-</span><span class="ruby-operator">-</span><span class="ruby-operator">-</span><span class="ruby-operator">-</span><span class="ruby-operator">-</span><span class="ruby-operator">-</span><span class="ruby-operator">-</span><span class="ruby-operator">-</span><span class="ruby-operator">-</span><span class="ruby-operator">-</span><span class="ruby-operator">+</span>
<span class="ruby-constant">YOUR</span>  =<span class="ruby-operator">&gt;</span><span class="ruby-operator">|</span><span class="ruby-constant">StreamWriter</span><span class="ruby-string">&#39;s  |=&gt;|Wrapped IO&#39;</span><span class="ruby-identifier">s</span><span class="ruby-operator">|=</span><span class="ruby-operator">&gt;</span> <span class="ruby-constant">ACTUAL</span>
<span class="ruby-constant">DATA</span>  =<span class="ruby-operator">&gt;</span><span class="ruby-operator">|</span><span class="ruby-identifier">internal</span> <span class="ruby-identifier">buffers</span><span class="ruby-operator">|=</span><span class="ruby-operator">&gt;</span><span class="ruby-operator">|</span><span class="ruby-identifier">buffers</span>     <span class="ruby-operator">|=</span><span class="ruby-operator">&gt;</span>  <span class="ruby-constant">FILE</span>
        <span class="ruby-operator">+</span><span class="ruby-operator">-</span><span class="ruby-operator">-</span><span class="ruby-operator">-</span><span class="ruby-operator">-</span><span class="ruby-operator">-</span><span class="ruby-operator">-</span><span class="ruby-operator">-</span><span class="ruby-operator">-</span><span class="ruby-operator">-</span><span class="ruby-operator">-</span><span class="ruby-operator">-</span><span class="ruby-operator">-</span><span class="ruby-operator">-</span><span class="ruby-operator">-</span><span class="ruby-operator">-</span><span class="ruby-operator">-</span><span class="ruby-operator">+</span>  <span class="ruby-operator">+</span><span class="ruby-operator">-</span><span class="ruby-operator">-</span><span class="ruby-operator">-</span><span class="ruby-operator">-</span><span class="ruby-operator">-</span><span class="ruby-operator">-</span><span class="ruby-operator">-</span><span class="ruby-operator">-</span><span class="ruby-operator">-</span><span class="ruby-operator">-</span><span class="ruby-operator">-</span><span class="ruby-operator">-</span><span class="ruby-operator">+</span>
</pre>

<p>This graphic also illustrates why it is unlikely to see written data
directly appear in the file on your harddisk; the data is cached at least
twice before it actually gets written out. Regarding file closing that
means that before you can be sure any pending data has been written to the
file you have to close both the <a
href="StreamWriter.html">StreamWriter</a> instance and then the wrapped IO
object (in <strong>exactly</strong> that order, otherwise data loss and
unexpected exceptions may occur!).</p>

<p>As it might be tedious to always remember the correct closing order, it’s
possible to pass a filename to the <a
href="StreamWriter.html#method-c-new">::new</a> method. In this case, <a
href="StreamWriter.html">StreamWriter</a> will open the file internally and
also takes care closing it when you call the <a
href="StreamWriter.html#method-i-close">close</a> method.</p>

<p>See the <code>io-like</code> gem’s documentation for the IO-writing methods
available for this class (although you’re probably familiar with them
through Ruby’s own IO class ;-)).</p>

<h2 id="label-Example">Example<span><a href="#label-Example">&para;</a> <a href="#documentation">&uarr;</a></span></h2>

<p>Together with the <code>archive-tar-minitar</code> gem, this library can be
used to create XZ-compressed TAR archives (these commonly use a file
extension of <code>.tar.xz</code> or rarely <code>.txz</code>).</p>

<pre class="ruby"><span class="ruby-constant">XZ</span><span class="ruby-operator">::</span><span class="ruby-constant">StreamWriter</span>.<span class="ruby-identifier">open</span>(<span class="ruby-string">&quot;foo.tar.xz&quot;</span>) <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">txz</span><span class="ruby-operator">|</span>
  <span class="ruby-comment"># This automatically closes txz</span>
  <span class="ruby-constant">Archive</span><span class="ruby-operator">::</span><span class="ruby-constant">Tar</span><span class="ruby-operator">::</span><span class="ruby-constant">Minitar</span>.<span class="ruby-identifier">pack</span>(<span class="ruby-string">&quot;foo&quot;</span>, <span class="ruby-identifier">txz</span>)
<span class="ruby-keyword">end</span>
</pre>

  </div><!-- description -->

  
  
  
  <section id="5Buntitled-5D" class="documentation-section">
    

    

    

    

    <!-- Methods -->
    
     <section id="public-class-5Buntitled-5D-method-details" class="method-section section">
      <h3 class="section-header">Public Class Methods</h3>

    
      <div id="method-c-new" class="method-detail ">
        
        
        <div class="method-heading">
          <span class="method-callseq">
            open(delegate, compression_level = 6, check = :crc64, extreme = false) → a_stream_writer
          </span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        
        <div class="method-heading">
          <span class="method-callseq">
            new(delegate, compression_level = 6, check = :crc64, extreme = false)  → a_stream_writer
          </span>
          
        </div>
        
        

        <div class="method-description">
          
          <p>Creates a new <a href="StreamWriter.html">StreamWriter</a> instance. The
block form automatically calls the <a
href="StreamWriter.html#method-i-close">close</a> method when the block has
finished executing.</p>

<h2 id="method-c-new-label-Parameters">Parameters<span><a href="#method-c-new-label-Parameters">&para;</a> <a href="#documentation">&uarr;</a></span></h2>
<dl class="rdoc-list label-list"><dt>delegate
<dd>
<p>An IO object to write the data to or a filename which will be opened
internally. If you pass an IO, the <a
href="StreamWriter.html#method-i-close">close</a> method won’t close the
passed IO object; if you passed a filename, the created internal file of
course gets closed.</p>
</dd></dl>

<p>The other parameters are identical to what the <a
href="../XZ.html#method-c-compress_stream">XZ.compress_stream</a> method
expects.</p>

<h2 id="method-c-new-label-Return+value">Return value<span><a href="#method-c-new-label-Return+value">&para;</a> <a href="#documentation">&uarr;</a></span></h2>

<p>The newly created instance.</p>

<h2 id="method-c-new-label-Example">Example<span><a href="#method-c-new-label-Example">&para;</a> <a href="#documentation">&uarr;</a></span></h2>

<pre># Wrap it around a file
f = File.open(&quot;data.xz&quot;)
w = XZ::StreamWriter.new(f)

# Use SHA256 as the checksum and use a higher compression level
# than the default (6)
f = File.open(&quot;data.xz&quot;)
w = XZ::StreamWriter.new(f, 8, :sha256)

# Instruct liblzma to use ultra-really-high compression
# (may take eternity)
f = File.open(&quot;data.xz&quot;)
w = XZ::StreamWriter.new(f, 9, :crc64, true)

# Passing a filename
w = XZ::StreamWriter.new(&quot;compressed_data.xz&quot;)</pre>
          
          
            <div class="method-calls-super">
              Calls superclass method
              <a href="Stream.html#method-c-new">XZ::Stream.new</a>
            </div>
          

          
          <div class="method-source-code" id="new-source">
            <pre><span class="ruby-comment"># File lib/xz/stream_writer.rb, line 100</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">initialize</span>(<span class="ruby-identifier">delegate</span>, <span class="ruby-identifier">compression_level</span> = <span class="ruby-value">6</span>, <span class="ruby-identifier">check</span> = <span class="ruby-value">:crc64</span>, <span class="ruby-identifier">extreme</span> = <span class="ruby-keyword">false</span>)
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">delegate</span>.<span class="ruby-identifier">respond_to?</span>(<span class="ruby-value">:to_io</span>)
    <span class="ruby-keyword">super</span>(<span class="ruby-identifier">delegate</span>)
  <span class="ruby-keyword">else</span>
    <span class="ruby-ivar">@file</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">open</span>(<span class="ruby-identifier">delegate</span>, <span class="ruby-string">&quot;wb&quot;</span>)
    <span class="ruby-keyword">super</span>(<span class="ruby-ivar">@file</span>)
  <span class="ruby-keyword">end</span>

  <span class="ruby-comment"># Initialize the internal LZMA stream for encoding</span>
  <span class="ruby-identifier">res</span> = <span class="ruby-constant">XZ</span><span class="ruby-operator">::</span><span class="ruby-constant">LibLZMA</span>.<span class="ruby-identifier">lzma_easy_encoder</span>(<span class="ruby-ivar">@lzma_stream</span>.<span class="ruby-identifier">pointer</span>,
                                <span class="ruby-identifier">compression_level</span> <span class="ruby-operator">|</span> (<span class="ruby-identifier">extreme</span> <span class="ruby-operator">?</span> <span class="ruby-constant">XZ</span><span class="ruby-operator">::</span><span class="ruby-constant">LibLZMA</span><span class="ruby-operator">::</span><span class="ruby-constant">LZMA_PRESET_EXTREME</span> <span class="ruby-operator">:</span> <span class="ruby-value">0</span>),
                                <span class="ruby-constant">XZ</span><span class="ruby-operator">::</span><span class="ruby-constant">LibLZMA</span><span class="ruby-operator">::</span><span class="ruby-constant">LZMA_CHECK</span>[<span class="ruby-value">:&quot;lzma_check_#{check}&quot;</span>])
  <span class="ruby-constant">XZ</span><span class="ruby-operator">::</span><span class="ruby-constant">LZMAError</span>.<span class="ruby-identifier">raise_if_necessary</span>(<span class="ruby-identifier">res</span>)

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">block_given?</span>
    <span class="ruby-keyword">begin</span>
      <span class="ruby-keyword">yield</span>(<span class="ruby-keyword">self</span>)
    <span class="ruby-keyword">ensure</span>
      <span class="ruby-identifier">close</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">closed?</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- new-source -->
          
        </div>

        

        
      </div><!-- new-method -->

    
    </section><!-- public-class-method-details -->
  
     <section id="public-instance-5Buntitled-5D-method-details" class="method-section section">
      <h3 class="section-header">Public Instance Methods</h3>

    
      <div id="method-i-close" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">close</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Closes this <a href="StreamWriter.html">StreamWriter</a> instance and
flushes all internal buffers. Don’t use it afterwards anymore.</p>

<h2 id="method-i-close-label-Return+vaule">Return vaule<span><a href="#method-i-close-label-Return+vaule">&para;</a> <a href="#documentation">&uarr;</a></span></h2>

<p>The total number of bytes written, i.e. the size of the compressed data.</p>

<h2 id="method-i-close-label-Example">Example<span><a href="#method-i-close-label-Example">&para;</a> <a href="#documentation">&uarr;</a></span></h2>

<pre class="ruby"><span class="ruby-identifier">w</span>.<span class="ruby-identifier">close</span> <span class="ruby-comment">#=&gt; 424</span>
</pre>

<h2 id="method-i-close-label-Remarks">Remarks<span><a href="#method-i-close-label-Remarks">&para;</a> <a href="#documentation">&uarr;</a></span></h2>

<p>If you passed an IO object to <a
href="StreamWriter.html#method-c-new">::new</a>, this method doesn’t close
it, you have to do that yourself.</p>
          
          
            <div class="method-calls-super">
              Calls superclass method
              
            </div>
          

          
          <div class="method-source-code" id="close-source">
            <pre><span class="ruby-comment"># File lib/xz/stream_writer.rb, line 134</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">close</span>
  <span class="ruby-keyword">super</span>

  <span class="ruby-comment">#1. Close the current block (&quot;file&quot;) (an XZ stream may actually include</span>
  <span class="ruby-comment">#   multiple compressed files, which however is not supported by</span>
  <span class="ruby-comment">#   this library). For this we have to tell liblzma that</span>
  <span class="ruby-comment">#   the next bytes we pass to it are the last bytes (by means of</span>
  <span class="ruby-comment">#   the FINISH action). Just that we don’t pass any new input ;-)</span>

  <span class="ruby-identifier">output_buffer_p</span>         = <span class="ruby-constant">FFI</span><span class="ruby-operator">::</span><span class="ruby-constant">MemoryPointer</span>.<span class="ruby-identifier">new</span>(<span class="ruby-constant">XZ</span><span class="ruby-operator">::</span><span class="ruby-constant">CHUNK_SIZE</span>)

  <span class="ruby-comment"># Get any pending data (LZMA_FINISH causes libzlma to flush its</span>
  <span class="ruby-comment"># internal buffers) and write it out to our wrapped IO.</span>
  <span class="ruby-identifier">loop</span> <span class="ruby-keyword">do</span>
    <span class="ruby-ivar">@lzma_stream</span>[<span class="ruby-value">:next_out</span>]  = <span class="ruby-identifier">output_buffer_p</span>
    <span class="ruby-ivar">@lzma_stream</span>[<span class="ruby-value">:avail_out</span>] = <span class="ruby-identifier">output_buffer_p</span>.<span class="ruby-identifier">size</span>

    <span class="ruby-identifier">res</span> = <span class="ruby-constant">XZ</span><span class="ruby-operator">::</span><span class="ruby-constant">LibLZMA</span>.<span class="ruby-identifier">lzma_code</span>(<span class="ruby-ivar">@lzma_stream</span>.<span class="ruby-identifier">pointer</span>, <span class="ruby-constant">XZ</span><span class="ruby-operator">::</span><span class="ruby-constant">LibLZMA</span><span class="ruby-operator">::</span><span class="ruby-constant">LZMA_ACTION</span>[<span class="ruby-value">:lzma_finish</span>])
    <span class="ruby-constant">XZ</span><span class="ruby-operator">::</span><span class="ruby-constant">LZMAError</span>.<span class="ruby-identifier">raise_if_necessary</span>(<span class="ruby-identifier">res</span>)

    <span class="ruby-ivar">@delegate_io</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">output_buffer_p</span>.<span class="ruby-identifier">read_string</span>(<span class="ruby-identifier">output_buffer_p</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">-</span> <span class="ruby-ivar">@lzma_stream</span>[<span class="ruby-value">:avail_out</span>]))

    <span class="ruby-keyword">break</span> <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@lzma_stream</span>[<span class="ruby-value">:avail_out</span>] <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-comment">#2. Close the whole XZ stream.</span>
  <span class="ruby-identifier">res</span> = <span class="ruby-constant">XZ</span><span class="ruby-operator">::</span><span class="ruby-constant">LibLZMA</span>.<span class="ruby-identifier">lzma_end</span>(<span class="ruby-ivar">@lzma_stream</span>.<span class="ruby-identifier">pointer</span>)
  <span class="ruby-constant">XZ</span><span class="ruby-operator">::</span><span class="ruby-constant">LZMAError</span>.<span class="ruby-identifier">raise_if_necessary</span>(<span class="ruby-identifier">res</span>)

  <span class="ruby-comment">#2b. If we wrapped a file automatically, close it.</span>
  <span class="ruby-ivar">@file</span>.<span class="ruby-identifier">close</span> <span class="ruby-keyword">if</span> <span class="ruby-ivar">@file</span>

  <span class="ruby-comment">#3. Return the number of bytes written in total.</span>
  <span class="ruby-ivar">@lzma_stream</span>[<span class="ruby-value">:total_out</span>]
<span class="ruby-keyword">end</span></pre>
          </div><!-- close-source -->
          
        </div>

        

        
      </div><!-- close-method -->

    
      <div id="method-i-pos" class="method-detail ">
        
        
        <div class="method-heading">
          <span class="method-callseq">
            pos()  → an_integer
          </span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        
        <div class="method-heading">
          <span class="method-callseq">
            tell() → an_integer
          </span>
          
        </div>
        
        

        <div class="method-description">
          
          <p>Total number of input bytes read so far from what you supplied to any
writer method.</p>
          
          

          
          <div class="method-source-code" id="pos-source">
            <pre><span class="ruby-comment"># File lib/xz/stream_writer.rb, line 176</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">pos</span>
  <span class="ruby-ivar">@lzma_stream</span>[<span class="ruby-value">:total_in</span>]
<span class="ruby-keyword">end</span></pre>
          </div><!-- pos-source -->
          
        </div>

        
        <div class="aliases">
          Also aliased as: <a href="StreamWriter.html#method-i-tell">tell</a>
        </div>
        

        
      </div><!-- pos-method -->

    
      <div id="method-i-tell" class="method-detail method-alias">
        
        <div class="method-heading">
          <span class="method-name">tell</span><span
            class="method-args">()</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
        </div>

        

        
        <div class="aliases">
          Alias for: <a href="StreamWriter.html#method-i-pos">pos</a>
        </div>
        
      </div><!-- tell-method -->

    
    </section><!-- public-instance-method-details -->
  
  </section><!-- 5Buntitled-5D -->

</div><!-- documentation -->


<footer id="validator-badges">
  <p><a href="http://validator.w3.org/check/referer">[Validate]</a>
  <p>Generated by <a href="https://github.com/rdoc/rdoc">RDoc</a> 4.0.0.
  <p>Generated with the <a href="http://deveiate.org/projects/Darkfish-Rdoc/">Darkfish Rdoc Generator</a> 3.
</footer>

